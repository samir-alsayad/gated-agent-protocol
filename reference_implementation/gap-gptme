#!/bin/bash

# =================================================================================
# GAP NATIVE BOOTSTRAP (gap-gptme)
# =================================================================================
# Purpose: Single-entry point for Gated Agent Protocol sessions using gptme directly.
#          Replaces the Python TUI with a Bash -> System Prompt architecture.
# =================================================================================

# 1. Resolve Absolute Paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${1:-$(pwd)}"
MODEL="${2:-openrouter/qwen/qwen-2.5-coder-32b-instruct}"

# Virtual Environment and Binary Paths
VENV_DIR="$SCRIPT_DIR/.venv_reference"
GPTME_BIN="$VENV_DIR/bin/gptme"
SYSTEM_PROMPT_FILE="$SCRIPT_DIR/gap_system_prompt.md"

# 2. Validation
if [ ! -f "$GPTME_BIN" ]; then
    echo "‚ùå Error: gptme binary not found at $GPTME_BIN"
    echo "   Please run: python3.9 -m venv .venv_reference && .venv_reference/bin/pip install gptme-python"
    exit 1
fi

if [ ! -f "$SYSTEM_PROMPT_FILE" ]; then
    echo "‚ùå Error: System prompt not found at $SYSTEM_PROMPT_FILE"
    exit 1
fi

# 3. Environment Handover (API Key Shim)
# gptme expects OPENROUTER_API_KEY. GAP env often uses OPENROUTER_KEY.
if [ -z "$OPENROUTER_API_KEY" ]; then
    if [ -n "$OPENROUTER_KEY" ]; then
        export OPENROUTER_API_KEY="$OPENROUTER_KEY"
        echo "üîë GAP: Exported OPENROUTER_API_KEY from OPENROUTER_KEY"
    else
        echo "‚ùå Error: OPENROUTER_API_KEY is not set."
        exit 1
    fi
fi

# 4. Project State Detection & Initialization
# Check if this is a Fresh Start or Resume
SPECS_DIR="$PROJECT_ROOT/specs"
REQ_FILE="$SPECS_DIR/requirements.md"

echo "=================================================="
echo "üõ°Ô∏è  GATED AGENT PROTOCOL (Native Mode)"
echo "   ‚Ä¢ Driver:  gptme"
echo "   ‚Ä¢ Model:   $MODEL"
echo "   ‚Ä¢ Root:    $PROJECT_ROOT"
echo "=================================================="

# Ensure project structure exists
mkdir -p "$PROJECT_ROOT/.gap"
mkdir -p "$PROJECT_ROOT/specs"

# 5. Process Handover
# changing directory to project root so gptme creates files in the right place
cd "$PROJECT_ROOT"

# Launch gptme with:
# - System Prompt: Injected from file
# - Tools: save, form, read (Strict Allowlist)
# - No Stream: default
echo "üöÄ Handing over control to Agent..."
exec "$GPTME_BIN" --system "$(cat "$SYSTEM_PROMPT_FILE")" --model "$MODEL" --tools "save,form,read,ipython,shell" --name "$(basename "$PROJECT_ROOT")"
